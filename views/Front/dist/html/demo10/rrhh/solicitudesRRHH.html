<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Listado de Solicitudes - RRHH</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4">Todas las Solicitudes</h2>

        <table class="table table-bordered bg-white">
            <thead class="table-dark">
                <tr>
                    <th>ID Solicitud</th>
                    <th>Tipo</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Motivo</th>
                    <th>Estado</th>
                    <th>Administrativo (Nombre - RUT)</th>
                    <th>Actualizar Estado</th>
                </tr>
            </thead>
            <tbody id="tablaSolicitudes">
                <tr>
                    <td colspan="8" class="text-center">Cargando solicitudes...</td>
                </tr>
            </tbody>
        </table>
        <a href="/rrhh/dashboard" class="btn btn-secondary mt-3 ms-2">Volver al Dashboard</a>
    </div>

    <script>
        async function cargarSolicitudes() {
            try {
                const res = await fetch('/rrhh/solicitudes');
                if (!res.ok) throw new Error('Error al cargar solicitudes');
                const data = await res.json();
                const tbody = document.getElementById('tablaSolicitudes');
                tbody.innerHTML = '';

                if (!data.solicitudes || data.solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay solicitudes.</td></tr>';
                    return;
                }

                data.solicitudes.forEach(solicitud => {
                    let estadoTexto = '';
                    switch (solicitud.estado) {
                        case 1: estadoTexto = 'En Espera'; break;
                        case 2: estadoTexto = 'Aprobado'; break;
                        case 3: estadoTexto = 'Rechazado'; break;
                        default: estadoTexto = 'Desconocido';
                    }

                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${new Date(solicitud.fechaInicio).toLocaleDateString()}</td>
                        <td>${new Date(solicitud.fechaFin).toLocaleDateString()}</td>
                        <td>${solicitud.motivo}</td>
                        <td id="estado-${solicitud.id}">${estadoTexto}</td>
                        <td> ${solicitud.nombre_completo} - ${solicitud.rut}</td>
                        <td>
                            <select id="select-estado-${solicitud.id}" class="form-select form-select-sm">
                                <option value="1" ${solicitud.estado === 1 ? 'selected' : ''}>En Espera</option>
                                <option value="2" ${solicitud.estado === 2 ? 'selected' : ''}>Aprobado</option>
                                <option value="3" ${solicitud.estado === 3 ? 'selected' : ''}>Rechazado</option>
                            </select>
                            <button class="btn btn-sm btn-primary mt-1" onclick="actualizarEstado(${solicitud.idAdministrativo}, ${solicitud.id})">Actualizar</button>
                        </td>
                        `;
                    tbody.appendChild(tr);
                });


            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function actualizarEstado(idAdministrativo, solicitudId) {
            const select = document.getElementById(`select-estado-${solicitudId}`);
            const nuevoEstado = parseInt(select.value);

            try {
                const res = await fetch('/rrhh/actualizarSolicitud', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado, solicitudId })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Error al actualizar estado');
                }

                const tdEstado = document.getElementById(`estado-${solicitudId}`);
                switch (nuevoEstado) {
                    case 1: tdEstado.textContent = 'En Espera'; break;
                    case 2: tdEstado.textContent = 'Aprobado'; break;
                    case 3: tdEstado.textContent = 'Rechazado'; break;
                    default: tdEstado.textContent = 'Desconocido';
                }

                alert('Estado actualizado correctamente.');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }


        cargarSolicitudes();
    </script>
</body>

</html>