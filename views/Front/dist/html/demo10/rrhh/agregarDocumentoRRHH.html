<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Agregar Documento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4">Subir Documento</h2>
        <form id="formDocumento" action="/rrhh/documentos/subir" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="administrativo_id" class="form-label">Seleccionar Persona</label>
                <select id="administrativo_id" name="administrativo_id" class="form-select" required></select>
            </div>
            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo de Documento</label>
                <select id="tipo" name="tipo" class="form-select" required>
                    <option value="" disabled selected>Seleccione un tipo</option>
                    <option value="Contrato">Contrato</option>
                    <option value="Liquidación">Liquidación</option>
                    <option value="Factura">Factura</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="razon" class="form-label">Razón o Contexto</label>
                <textarea id="razon" name="razon" class="form-control" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="documento" class="form-label">Archivo</label>
                <input type="file" id="documento" name="documentos" class="form-control"
                    accept=".pdf,.doc,.docx,.jpg,.png" multiple required>
            </div>
            <button type="submit" class="btn btn-primary">Subir Documento</button>
            <a href="/rrhh/dashboard" class="btn btn-secondary ms-2">Volver</a>
        </form>
    </div>

    <script>
        // Cargar administrativos en el select
        async function cargarAdministrativos() {
            try {
                const res = await fetch('/rrhh/administrativos');
                if (!res.ok) throw new Error('Error al cargar administrativos');
                const data = await res.json();
                const select = document.getElementById('administrativo_id');
                select.innerHTML = '<option value="">Seleccione una persona</option>'; // limpio opciones previas
                data.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.id;
                    option.textContent = `${persona.nombre_completo} (${persona.rut})`;
                    select.appendChild(option);
                });
            } catch (error) {
                alert(error.message);
            }
        }

        cargarAdministrativos();

        // Manejar el envío del formulario
        document.getElementById('formDocumento').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    // Redirigir a la vista de documentos subidos por RRHH
                    window.location.href = '/rrhh/documentos/vista/subidos';
                } else {
                    const errorData = await res.json();
                    alert('Error al subir documentos: ' + (errorData.error || 'Error desconocido'));
                }
            } catch (err) {
                alert('Error de conexión: ' + err.message);
            }
        });
    </script>

</body>

</html>