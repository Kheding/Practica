<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Planes de Mejora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4">Planes de Mejora</h2>

        <table class="table table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Responsable</th>
                    <th>Inicio</th>
                    <th>Esperado Fin</th>
                    <th>Fin Real</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaPlanes">
                <tr>
                    <td colspan="7" class="text-center">Cargando datos...</td>
                </tr>
            </tbody>
        </table>

        <a href="/jo/dashboard" class="btn btn-secondary">Volver</a>
    </div>

    <!-- Modal para confirmar acci칩n -->
    <div class="modal fade" id="modalAccion" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formEstadoProyecto" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Actualizar Estado del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal_idProyecto">
                    <input type="hidden" id="modal_estado">

                    <div class="mb-3">
                        <label for="modal_fechaFinReal" class="form-label">Fecha de finalizaci칩n real</label>
                        <input type="date" id="modal_fechaFinReal" class="form-control" required>
                    </div>

                    <p class="text-muted">Esta acci칩n actualizar치 el estado del plan.</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Confirmar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function cargarPlanes() {
            try {
                const res = await fetch('/jo/planes-mejora');
                const planes = await res.json();

                const tbody = document.getElementById('tablaPlanes');
                tbody.innerHTML = "";

                if (planes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay planes de mejora registrados.</td></tr>';
                    return;
                }

                for (const p of planes) {
                    const finReal = p.fechaFinReal ? new Date(p.fechaFinReal).toLocaleDateString() : '-';
                    const fila = `
                    <tr>
                        <td>${p.nombre}</td>
                        <td>${p.responsable}</td>
                        <td>${new Date(p.fechaInicio).toLocaleDateString()}</td>
                        <td>${new Date(p.fechaEsperadaFin).toLocaleDateString()}</td>
                        <td>${finReal}</td>
                        <td>${p.estado}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="abrirModal(${p.idProyecto}, 'verde')">Aprobar</button>
                            <button class="btn btn-danger btn-sm" onclick="abrirModal(${p.idProyecto}, 'rojo')">Rechazar</button>
                            <button class="btn btn-warning btn-sm" onclick="abrirModal(${p.idProyecto}, 'amarillo')">Terminar</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += fila;
                }
            } catch (err) {
                console.error('Error al cargar planes:', err);
            }
        }

        function abrirModal(idProyecto, estado) {
            document.getElementById('modal_idProyecto').value = idProyecto;
            document.getElementById('modal_estado').value = estado;
            document.getElementById('modal_fechaFinReal').valueAsDate = new Date();
            const modal = new bootstrap.Modal(document.getElementById('modalAccion'));
            modal.show();
        }

        document.getElementById('formEstadoProyecto').addEventListener('submit', async function (e) {
            e.preventDefault();

            const idProyecto = document.getElementById('modal_idProyecto').value;
            const estado = document.getElementById('modal_estado').value;
            const fechaFinReal = document.getElementById('modal_fechaFinReal').value;

            try {
                const res = await fetch('/jo/planes-mejora/aprobar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idProyecto, estado, fechaFinReal })
                });

                if (res.ok) {
                    alert('Proyecto actualizado correctamente');
                    location.reload();
                } else {
                    const data = await res.json();
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (err) {
                alert('Error de red: ' + err.message);
            }
        });

        cargarPlanes();
    </script>
</body>

</html>