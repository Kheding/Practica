<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listado de Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4">Clientes de Mi Sede</h2>

        <!-- Checkbox filtro membresía activa -->
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="membresiaActivaCheckbox" checked>
            <label class="form-check-label" for="membresiaActivaCheckbox">
                Mostrar solo clientes con membresía activa
            </label>
        </div>

        <!-- Barra de búsqueda -->
        <input type="text" id="searchInput" class="form-control mb-3"
            placeholder="Buscar por nombre, apellido, correo o teléfono...">

        <div class="table-responsive">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Membresía</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientesTableBody"></tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center my-3">
            <button id="prevBtn" class="btn btn-outline-primary btn-sm">Anterior</button>
            <span id="pageInfo"></span>
            <button id="nextBtn" class="btn btn-outline-primary btn-sm">Siguiente</button>
        </div>

        <a href="/staff/dashboard" class="btn btn-secondary mt-3">Volver al Dashboard</a>
    </div>

    <script>
        let clientes = [];
        let clientesFiltrados = [];
        let currentPage = 1;
        const porPagina = 10;

        async function cargarClientes() {
            try {
                const res = await fetch('/staff/apiListarClientes');
                clientes = await res.json();
                aplicarFiltro();
            } catch (err) {
                console.error('Error al cargar clientes:', err);
                alert('Error al cargar datos.');
            }
        }

        function aplicarFiltro() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtrarActivos = document.getElementById('membresiaActivaCheckbox').checked;

            clientesFiltrados = clientes.filter(c => {
                const coincide = (c.Nombre?.toLowerCase().includes(term) ||
                    c.Apellido?.toLowerCase().includes(term) ||
                    c.CorreoElectronico?.toLowerCase().includes(term) ||
                    c.TelefonoMovil?.toLowerCase().includes(term));

                const activa = c.VencimientoPlan && new Date(c.VencimientoPlan) > new Date();

                return coincide && (filtrarActivos ? activa : true);
            });

            currentPage = 1;
            render();
        }

        function render() {
            const tbody = document.getElementById('clientesTableBody');
            tbody.innerHTML = '';
            const totalPag = Math.ceil(clientesFiltrados.length / porPagina);
            if (currentPage > totalPag) currentPage = totalPag || 1;

            const start = (currentPage - 1) * porPagina;
            const pagina = clientesFiltrados.slice(start, start + porPagina);

            for (const cliente of pagina) {
                const activa = cliente.VencimientoPlan && new Date(cliente.VencimientoPlan) > new Date();
                const badge = activa ? 'bg-success' : 'bg-secondary';
                const estado = activa ? 'Activa' : 'Inactiva';

                const row = document.createElement('tr');
                row.innerHTML = `
          <td>${cliente.IdCliente}</td>
          <td>${cliente.Nombre}</td>
          <td>${cliente.Apellido}</td>
          <td>${cliente.CorreoElectronico || ''}</td>
          <td>${cliente.TelefonoMovil || ''}</td>
          <td><span class="badge ${badge}">${estado}</span></td>
          <td>
            <a href="/staff/editarCliente?id=${cliente.IdCliente}" class="btn btn-sm btn-warning me-1">Editar</a>
            <button class="btn btn-sm btn-danger" onclick="eliminarCliente(${cliente.IdCliente})">Eliminar</button>
          </td>
        `;
                tbody.appendChild(row);
            }

            document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPag || 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPag;
        }

        function eliminarCliente(id) {
            if (!confirm('¿Estás seguro de eliminar este cliente?')) return;

            fetch(`/staff/apiEliminarCliente/${id}`, {
                method: 'DELETE'
            }).then(res => {
                if (res.ok) {
                    clientes = clientes.filter(c => c.IdCliente !== id);
                    aplicarFiltro();
                } else {
                    alert('Error al eliminar cliente');
                }
            });
        }

        document.getElementById('searchInput').addEventListener('input', aplicarFiltro);
        document.getElementById('membresiaActivaCheckbox').addEventListener('change', aplicarFiltro);
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                render();
            }
        });
        document.getElementById('nextBtn').addEventListener('click', () => {
            const total = Math.ceil(clientesFiltrados.length / porPagina);
            if (currentPage < total) {
                currentPage++;
                render();
            }
        });

        cargarClientes();
    </script>
</body>

</html>